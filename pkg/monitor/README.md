# Monitor Package - ä¼ä¸šçº§ç³»ç»Ÿç›‘æ§åŒ…

ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„Goè¯­è¨€ç³»ç»Ÿç›‘æ§åŒ…ï¼Œæä¾›å®æ—¶ç³»ç»Ÿèµ„æºç›‘æ§ã€å‘Šè­¦ç®¡ç†ã€æ•°æ®æŒä¹…åŒ–ç­‰ä¼ä¸šçº§åŠŸèƒ½ã€‚

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

### ğŸ“Š å…¨é¢çš„ç³»ç»Ÿç›‘æ§
- **CPUç›‘æ§** - å®æ—¶CPUä½¿ç”¨ç‡ã€æ ¸å¿ƒæ•°ç»Ÿè®¡
- **å†…å­˜ç›‘æ§** - å†…å­˜ä½¿ç”¨é‡ã€å¯ç”¨é‡ã€äº¤æ¢åˆ†åŒºç›‘æ§
- **ç£ç›˜ç›‘æ§** - ç£ç›˜ä½¿ç”¨ç‡ã€I/Oç»Ÿè®¡ã€æŒ‚è½½ç‚¹ä¿¡æ¯
- **ç½‘ç»œç›‘æ§** - ç½‘ç»œæ¥å£çŠ¶æ€ã€æµé‡ç»Ÿè®¡ã€è¿æ¥ä¿¡æ¯
- **è¿›ç¨‹ç›‘æ§** - è¿›ç¨‹åˆ—è¡¨ã€èµ„æºä½¿ç”¨ã€è¿›ç¨‹æ ‘åˆ†æ
- **ç³»ç»Ÿè´Ÿè½½** - ç³»ç»Ÿè´Ÿè½½å¹³å‡å€¼ç›‘æ§

### ğŸš¨ æ™ºèƒ½å‘Šè­¦ç³»ç»Ÿ
- **è§„åˆ™å¼•æ“** - çµæ´»çš„å‘Šè­¦è§„åˆ™é…ç½®
- **å¤šçº§å‘Šè­¦** - æ”¯æŒInfoã€Warningã€Criticalç­‰å¤šç§å‘Šè­¦çº§åˆ«
- **å‘Šè­¦å¤„ç†å™¨** - æ”¯æŒæ—¥å¿—ã€é‚®ä»¶ã€Webhookç­‰å¤šç§é€šçŸ¥æ–¹å¼
- **å‘Šè­¦èšåˆ** - é˜²æ­¢å‘Šè­¦é£æš´ï¼Œæ”¯æŒå‘Šè­¦å»é‡å’Œèšåˆ
- **å†å²è®°å½•** - å®Œæ•´çš„å‘Šè­¦å†å²è®°å½•å’ŒçŠ¶æ€è·Ÿè¸ª

### ğŸ’¾ æ•°æ®æŒä¹…åŒ–
- **æ–‡ä»¶å­˜å‚¨** - é«˜æ•ˆçš„æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼Œæ”¯æŒæ•°æ®å‹ç¼©å’Œè½®è½¬
- **å†…å­˜å­˜å‚¨** - é«˜æ€§èƒ½å†…å­˜å­˜å‚¨ï¼Œé€‚ç”¨äºä¸´æ—¶æ•°æ®
- **æŸ¥è¯¢æ¥å£** - æ”¯æŒæ—¶é—´èŒƒå›´ã€æ ‡ç­¾è¿‡æ»¤ç­‰å¤æ‚æŸ¥è¯¢
- **æ•°æ®ä¿ç•™** - è‡ªåŠ¨æ•°æ®æ¸…ç†å’Œä¿ç•™ç­–ç•¥

### ğŸ“ˆ æ•°æ®èšåˆåˆ†æ
- **å®æ—¶èšåˆ** - å®æ—¶è®¡ç®—å¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼ç­‰ç»Ÿè®¡æŒ‡æ ‡
- **å†å²è¶‹åŠ¿** - æ”¯æŒå†å²æ•°æ®è¶‹åŠ¿åˆ†æ
- **ç¼“å­˜ä¼˜åŒ–** - å†…ç½®ç¼“å­˜æœºåˆ¶ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
- **åˆ†é¡µæŸ¥è¯¢** - æ”¯æŒå¤§æ•°æ®é‡çš„åˆ†é¡µæŸ¥è¯¢

### ğŸ”§ é«˜åº¦å¯æ‰©å±•
- **è‡ªå®šä¹‰æ”¶é›†å™¨** - æ”¯æŒè‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡æ”¶é›†å™¨
- **æ’ä»¶æ¶æ„** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
- **é…ç½®é©±åŠ¨** - çµæ´»çš„é…ç½®ç³»ç»Ÿï¼Œæ”¯æŒåŠ¨æ€é…ç½®
- **è·¨å¹³å°** - æ”¯æŒLinuxã€macOSã€Windowsç­‰å¤šç§æ“ä½œç³»ç»Ÿ

## ğŸ“¦ å®‰è£…

```bash
go get github.com/tokmz/basic/pkg/monitor
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```go
package main

import (
    "context"
    "fmt"
    "log"
    "time"
    
    "github.com/tokmz/basic/pkg/monitor"
)

func main() {
    // 1. åˆ›å»ºç›‘æ§å™¨
    config := monitor.DefaultMonitorConfig()
    monitor := monitor.NewSystemMonitor(config)
    
    // 2. è·å–ç³»ç»Ÿä¿¡æ¯
    systemInfo, err := monitor.GetSystemInfo()
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("Hostname: %s\n", systemInfo.Hostname)
    fmt.Printf("OS: %s\n", systemInfo.OS)
    
    if systemInfo.CPU != nil {
        fmt.Printf("CPU Cores: %d, Usage: %.2f%%\n", 
            systemInfo.CPU.Cores, systemInfo.CPU.Usage)
    }
    
    if systemInfo.Memory != nil {
        fmt.Printf("Memory Usage: %.2f%%\n", systemInfo.Memory.UsagePercent)
    }
}
```

### å¸¦ç›‘æ§å¾ªç¯çš„ä½¿ç”¨

```go
func main() {
    // åˆ›å»ºé…ç½®
    config := &monitor.MonitorConfig{
        Interval:      5 * time.Second,
        EnableCPU:     true,
        EnableMemory:  true,
        EnableDisk:    true,
        EnableNetwork: true,
        HistorySize:   1000,
    }
    
    monitor := monitor.NewSystemMonitor(config)
    
    // å¯åŠ¨ç›‘æ§
    ctx, cancel := context.WithTimeout(context.Background(), time.Minute)
    defer cancel()
    
    err := monitor.Start(ctx)
    if err != nil {
        log.Fatal(err)
    }
    defer monitor.Stop()
    
    // å®šæœŸè·å–ç›‘æ§æ•°æ®
    ticker := time.NewTicker(10 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-ctx.Done():
            return
        case <-ticker.C:
            summary := monitor.GetSystemSummary()
            if summary != nil {
                fmt.Printf("CPU: %.2f%%, Memory: %.2f%%\n", 
                    summary.CPU.Current, summary.Memory.UsagePercent)
            }
        }
    }
}
```

## ğŸ”” å‘Šè­¦é…ç½®

### è®¾ç½®å‘Šè­¦è§„åˆ™

```go
// CPUä½¿ç”¨ç‡å‘Šè­¦
cpuAlert := &monitor.AlertRule{
    ID:        "cpu-high",
    Name:      "CPUä½¿ç”¨ç‡è¿‡é«˜",
    Type:      monitor.TypeCPU,
    Severity:  monitor.SeverityWarning,
    Enabled:   true,
    Threshold: 80.0,
    Operator:  ">",
    Duration:  time.Minute,
    Labels:    map[string]string{"team": "ops"},
}

monitor.SetAlertRule(cpuAlert)

// å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
memoryAlert := &monitor.AlertRule{
    ID:        "memory-high", 
    Name:      "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜",
    Type:      monitor.TypeMemory,
    Severity:  monitor.SeverityCritical,
    Enabled:   true,
    Threshold: 90.0,
    Operator:  ">",
    Duration:  30 * time.Second,
}

monitor.SetAlertRule(memoryAlert)
```

### æ³¨å†Œå‘Šè­¦å¤„ç†å™¨

```go
// æ—¥å¿—å¤„ç†å™¨
logHandler := monitor.NewLogAlertHandler(nil)
monitor.RegisterAlertHandler(logHandler)

// é‚®ä»¶å¤„ç†å™¨
emailHandler := monitor.NewEmailAlertHandler(
    "smtp.example.com",
    "monitor@example.com", 
    []string{"admin@example.com"},
)
monitor.RegisterAlertHandler(emailHandler)

// Webhookå¤„ç†å™¨
webhookHandler := monitor.NewWebhookAlertHandler("http://localhost:8080/alerts")
monitor.RegisterAlertHandler(webhookHandler)
```

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–

### å¯ç”¨æ–‡ä»¶å­˜å‚¨

```go
config := &monitor.MonitorConfig{
    EnablePersist:   true,
    PersistPath:     "./monitor_data",
    PersistInterval: 5 * time.Minute,
    // å…¶ä»–é…ç½®...
}

monitor := monitor.NewSystemMonitor(config)
```

### æŸ¥è¯¢å†å²æ•°æ®

```go
// æŸ¥è¯¢æœ€è¿‘1å°æ—¶çš„æ•°æ®
history, err := monitor.GetMetricsHistory(time.Hour)
if err != nil {
    log.Fatal(err)
}

fmt.Printf("CPU history points: %d\n", len(history.CPU))
fmt.Printf("Memory history points: %d\n", len(history.Memory))

// æŸ¥è¯¢ç‰¹å®šæ—¶é—´èŒƒå›´çš„æ•°æ®
if monitor.storage != nil {
    startTime := time.Now().Add(-time.Hour)
    endTime := time.Now()
    
    query := &monitor.Query{
        Type:      "system",
        StartTime: &startTime,
        EndTime:   &endTime,
        Limit:     100,
    }
    
    results, err := monitor.storage.Load(query)
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("Found %d records\n", len(results))
}
```

## ğŸ”§ è‡ªå®šä¹‰æ‰©å±•

### è‡ªå®šä¹‰æŒ‡æ ‡æ”¶é›†å™¨

```go
type CustomCollector struct {
    name string
}

func (c *CustomCollector) Collect() (interface{}, error) {
    return map[string]interface{}{
        "timestamp": time.Now(),
        "value":     rand.Float64() * 100,
        "status":    "healthy",
    }, nil
}

func (c *CustomCollector) Name() string {
    return c.name
}

func (c *CustomCollector) Labels() map[string]string {
    return map[string]string{
        "type": "custom",
        "service": "my-service",
    }
}

// æ³¨å†Œè‡ªå®šä¹‰æ”¶é›†å™¨
collector := &CustomCollector{name: "my-metric"}
monitor.AddMetric("my-metric", collector)
```

### è‡ªå®šä¹‰å‘Šè­¦å¤„ç†å™¨

```go
type SlackAlertHandler struct {
    webhookURL string
}

func (h *SlackAlertHandler) Handle(alert *monitor.Alert) error {
    message := fmt.Sprintf("ğŸš¨ Alert: %s\nSeverity: %s\nValue: %.2f", 
        alert.Message, alert.Severity, alert.Value)
    
    // å‘é€åˆ°Slack
    return sendSlackMessage(h.webhookURL, message)
}

func (h *SlackAlertHandler) Name() string {
    return "slack"
}

func (h *SlackAlertHandler) IsAsync() bool {
    return true
}

// æ³¨å†Œå¤„ç†å™¨
slackHandler := &SlackAlertHandler{webhookURL: "https://hooks.slack.com/..."}
monitor.RegisterAlertHandler(slackHandler)
```

## ğŸ“Š é…ç½®é€‰é¡¹

### MonitorConfig è¯¦ç»†é…ç½®

```go
type MonitorConfig struct {
    // åŸºæœ¬é…ç½®
    Interval        time.Duration // ç›‘æ§é—´éš”ï¼Œé»˜è®¤30ç§’
    EnableCPU       bool          // å¯ç”¨CPUç›‘æ§
    EnableMemory    bool          // å¯ç”¨å†…å­˜ç›‘æ§  
    EnableDisk      bool          // å¯ç”¨ç£ç›˜ç›‘æ§
    EnableNetwork   bool          // å¯ç”¨ç½‘ç»œç›‘æ§
    EnableProcess   bool          // å¯ç”¨è¿›ç¨‹ç›‘æ§ï¼ˆæ€§èƒ½å¼€é”€è¾ƒå¤§ï¼‰
    EnableLoad      bool          // å¯ç”¨è´Ÿè½½ç›‘æ§
    
    // å†å²æ•°æ®é…ç½®
    HistorySize     int           // å†å²æ•°æ®å¤§å°ï¼Œé»˜è®¤1000
    HistoryInterval time.Duration // å†å²æ•°æ®é—´éš”ï¼Œé»˜è®¤1åˆ†é’Ÿ
    
    // è¿›ç¨‹ç›‘æ§é…ç½®
    ProcessFilters    []string    // è¿›ç¨‹è¿‡æ»¤å™¨
    TopProcessCount   int         // ä¿å­˜çš„topè¿›ç¨‹æ•°é‡
    CollectProcessEnv bool        // æ˜¯å¦æ”¶é›†è¿›ç¨‹ç¯å¢ƒå˜é‡
    
    // ç£ç›˜å’Œç½‘ç»œè¿‡æ»¤å™¨
    DiskFilters     []string      // ç£ç›˜è¿‡æ»¤å™¨
    NetworkFilters  []string      // ç½‘ç»œæ¥å£è¿‡æ»¤å™¨
    
    // å‘Šè­¦é…ç½®
    EnableAlert     bool          // å¯ç”¨å‘Šè­¦
    
    // æŒä¹…åŒ–é…ç½®  
    EnablePersist   bool          // å¯ç”¨æ•°æ®æŒä¹…åŒ–
    PersistPath     string        // æŒä¹…åŒ–è·¯å¾„
    PersistInterval time.Duration // æŒä¹…åŒ–é—´éš”
}
```

### é¢„è®¾é…ç½®

```go
// å¼€å‘ç¯å¢ƒé…ç½®
config := monitor.DefaultMonitorConfig()

// ç”Ÿäº§ç¯å¢ƒé…ç½®
config := &monitor.MonitorConfig{
    Interval:        10 * time.Second,
    EnableCPU:       true,
    EnableMemory:    true,
    EnableDisk:      true,
    EnableNetwork:   true,
    EnableProcess:   false, // ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­
    EnableLoad:      true,
    EnableAlert:     true,
    EnablePersist:   true,
    PersistPath:     "/var/log/monitor",
    PersistInterval: time.Minute,
    HistorySize:     5000,
}

// æµ‹è¯•ç¯å¢ƒé…ç½®  
config := &monitor.MonitorConfig{
    Interval:      time.Second,
    EnableCPU:     true,
    EnableMemory:  true,
    EnableDisk:    false,
    EnableNetwork: false,
    EnableProcess: false,
    EnableAlert:   false,
    HistorySize:   100,
}
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡Œç‰¹å®šæµ‹è¯•
go test -v -run TestSystemMonitor

# è¿è¡ŒåŸºå‡†æµ‹è¯•
go test -bench=.

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
go test -cover ./...
```

## ğŸ“ˆ æ€§èƒ½ç‰¹å¾

- **å†…å­˜ä½¿ç”¨**: åŸºç¡€é…ç½®ä¸‹çº¦10-20MB
- **CPUå¼€é”€**: æ­£å¸¸æƒ…å†µä¸‹<1%
- **ç›‘æ§ç²¾åº¦**: ç§’çº§ç›‘æ§ï¼Œå¯é…ç½®
- **å†å²æ•°æ®**: æ”¯æŒæ•°åƒä¸ªæ•°æ®ç‚¹çš„å†…å­˜å­˜å‚¨
- **å¹¶å‘å®‰å…¨**: å…¨å±€è¯»å†™é”ä¿æŠ¤ï¼Œæ”¯æŒå¹¶å‘è®¿é—®

## ğŸš€ æœ€ä½³å®è·µ

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **åˆç†è®¾ç½®ç›‘æ§é—´éš”**: å»ºè®®10-30ç§’ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„ç›‘æ§
2. **å¯ç”¨æ•°æ®æŒä¹…åŒ–**: ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨æ–‡ä»¶å­˜å‚¨
3. **å…³é—­è¿›ç¨‹ç›‘æ§**: é™¤éå¿…è¦ï¼Œå»ºè®®å…³é—­è¿›ç¨‹ç›‘æ§ä»¥å‡å°‘å¼€é”€
4. **é…ç½®å‘Šè­¦è§„åˆ™**: è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼å’ŒæŒç»­æ—¶é—´
5. **ç›‘æ§è‡ªèº«**: å®šæœŸæ£€æŸ¥ç›‘æ§ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€

### å‘Šè­¦è§„åˆ™å»ºè®®

```go
// CPUå‘Šè­¦ - ä¿å®ˆç­–ç•¥
&monitor.AlertRule{
    Type:      monitor.TypeCPU,
    Threshold: 70.0,
    Operator:  ">",
    Duration:  2 * time.Minute, // æŒç»­2åˆ†é’Ÿ
    Severity:  monitor.SeverityWarning,
}

// å†…å­˜å‘Šè­¦ - æ¿€è¿›ç­–ç•¥  
&monitor.AlertRule{
    Type:      monitor.TypeMemory,
    Threshold: 85.0,
    Operator:  ">", 
    Duration:  30 * time.Second,
    Severity:  monitor.SeverityCritical,
}

// ç£ç›˜ç©ºé—´å‘Šè­¦
&monitor.AlertRule{
    Type:      monitor.TypeDisk,
    Threshold: 90.0,
    Operator:  ">",
    Duration:  time.Minute,
    Severity:  monitor.SeverityCritical,
}
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# å…‹éš†ä»“åº“
git clone <repository-url>
cd basic/pkg/monitor

# å®‰è£…ä¾èµ–
go mod tidy

# è¿è¡Œæµ‹è¯•
go test ./...
```

### ä»£ç è§„èŒƒ

- éµå¾ªGoå®˜æ–¹ä»£ç è§„èŒƒ
- ä½¿ç”¨`gofmt`æ ¼å¼åŒ–ä»£ç 
- é€šè¿‡`go vet`é™æ€æ£€æŸ¥
- æ·»åŠ å¿…è¦çš„å•å…ƒæµ‹è¯•
- æ›´æ–°ç›¸å…³æ–‡æ¡£

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](../../LICENSE) æ–‡ä»¶

## ğŸ”— ç›¸å…³é“¾æ¥

- [LoggeråŒ…æ–‡æ¡£](../logger/README.md)
- [ConfigåŒ…æ–‡æ¡£](../config/README.md)
- [é¡¹ç›®ä¸»é¡µ](../../README.md)

## ğŸ“ æ”¯æŒä¸åé¦ˆ

- æäº¤IssuesæŠ¥å‘Šé—®é¢˜
- å‚ä¸Discussionsè®¨è®º
- è´¡çŒ®ä»£ç å’Œæ–‡æ¡£

---

**ğŸ”§ é«˜æ€§èƒ½ â€¢ ğŸš¨ æ™ºèƒ½å‘Šè­¦ â€¢ ğŸ’¾ æ•°æ®æŒä¹…åŒ– â€¢ ğŸ“Š å®æ—¶ç›‘æ§ â€¢ ğŸ”Œ æ˜“äºæ‰©å±•**