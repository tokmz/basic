# Config Package - ä¼ä¸šçº§é…ç½®ç®¡ç†ç³»ç»Ÿ

åŸºäº Viper çš„é«˜æ€§èƒ½ä¼ä¸šçº§é…ç½®ç®¡ç†åŒ…ï¼Œæä¾›å®Œæ•´çš„é…ç½®ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå¤šç¯å¢ƒã€åŠ å¯†ã€éªŒè¯ã€çƒ­é‡è½½ç­‰ä¼ä¸šçº§ç‰¹æ€§ã€‚

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

### ğŸš€ é«˜æ€§èƒ½é…ç½®ç®¡ç†
- **åŸºäº Viper** - ä½¿ç”¨æˆç†Ÿç¨³å®šçš„ Viper åº“ä½œä¸ºåº•å±‚å¼•æ“
- **å¤šæ ¼å¼æ”¯æŒ** - æ”¯æŒ YAMLã€JSONã€TOMLã€HCLã€INI ç­‰é…ç½®æ ¼å¼
- **ç¯å¢ƒå˜é‡é›†æˆ** - æ— ç¼é›†æˆç¯å¢ƒå˜é‡ï¼Œæ”¯æŒå‰ç¼€å’Œé”®æ˜ å°„
- **è¿œç¨‹é…ç½®æ”¯æŒ** - æ”¯æŒ etcdã€Consulã€Firestore ç­‰è¿œç¨‹é…ç½®æº

### ğŸ” å®‰å…¨åŠ å¯†åŠŸèƒ½
- **AES åŠ å¯†** - å†…ç½® AES-GCM åŠ å¯†ç®—æ³•ä¿æŠ¤æ•æ„Ÿé…ç½®
- **é€‰æ‹©æ€§åŠ å¯†** - å¯æŒ‡å®šç‰¹å®šé…ç½®é¡¹è¿›è¡ŒåŠ å¯†
- **é€æ˜è§£å¯†** - è‡ªåŠ¨åŠ è§£å¯†ï¼Œå¯¹ä¸šåŠ¡ä»£ç é€æ˜
- **å¯†é’¥ç®¡ç†** - æ”¯æŒé…ç½®å¯†é’¥è½®æ¢å’Œç®¡ç†

### ğŸŒ å¤šç¯å¢ƒç®¡ç†
- **ç¯å¢ƒè‡ªåŠ¨æ£€æµ‹** - è‡ªåŠ¨æ£€æµ‹å½“å‰è¿è¡Œç¯å¢ƒ
- **ç¯å¢ƒç‰¹å®šé…ç½®** - æ”¯æŒä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®æ–‡ä»¶
- **é…ç½®ç»§æ‰¿** - æ”¯æŒé…ç½®å±‚çº§å’Œç»§æ‰¿æœºåˆ¶
- **ç¯å¢ƒåˆ‡æ¢** - æ”¯æŒè¿è¡Œæ—¶ç¯å¢ƒåˆ‡æ¢

### âœ… é…ç½®éªŒè¯
- **ç±»å‹å®‰å…¨** - å¼ºç±»å‹é…ç½®éªŒè¯
- **è‡ªå®šä¹‰è§„åˆ™** - æ”¯æŒè‡ªå®šä¹‰éªŒè¯è§„åˆ™
- **èŒƒå›´æ£€æŸ¥** - æ”¯æŒæ•°å€¼èŒƒå›´å’Œé€‰é¡¹éªŒè¯
- **å¿…å¡«é¡¹æ£€æŸ¥** - æ”¯æŒå¿…å¡«é…ç½®é¡¹éªŒè¯

### ğŸ”„ çƒ­é‡è½½æœºåˆ¶
- **æ–‡ä»¶ç›‘å¬** - ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨é‡è½½
- **äº‹ä»¶é€šçŸ¥** - é…ç½®å˜åŒ–äº‹ä»¶é€šçŸ¥æœºåˆ¶
- **å›è°ƒæ”¯æŒ** - æ”¯æŒé…ç½®å˜åŒ–å›è°ƒå‡½æ•°
- **åŸå­æ›´æ–°** - ä¿è¯é…ç½®æ›´æ–°çš„åŸå­æ€§

### ğŸ­ å·¥å‚æ¨¡å¼
- **å¤šç§ç®¡ç†å™¨** - æ”¯æŒåŸºç¡€ã€åŠ å¯†ã€ç¯å¢ƒç­‰å¤šç§ç®¡ç†å™¨ç±»å‹
- **è‡ªåŠ¨æ£€æµ‹** - æ ¹æ®é…ç½®è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ç®¡ç†å™¨ç±»å‹
- **æ³¨å†Œæœºåˆ¶** - æ”¯æŒç®¡ç†å™¨æ³¨å†Œå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- **é¢„è®¾å·¥å‚** - æä¾›å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒé¢„è®¾

## ğŸ“¦ å®‰è£…

```bash
go get github.com/tokmz/basic/pkg/config
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```go
package main

import (
    "fmt"
    "log"
    
    "github.com/tokmz/basic/pkg/config"
)

func main() {
    // åˆå§‹åŒ–å…¨å±€é…ç½®
    err := config.Init(config.DevelopmentConfig())
    if err != nil {
        log.Fatal(err)
    }
    defer config.Close()
    
    // è¯»å–é…ç½®
    dbHost := config.GetString("database.host")
    dbPort := config.GetInt("database.port")
    debugMode := config.GetBool("debug")
    
    fmt.Printf("Database: %s:%d, Debug: %t\n", dbHost, dbPort, debugMode)
}
```

### Builderæ¨¡å¼ä½¿ç”¨

```go
manager, err := config.NewConfigBuilder().
    WithConfigName("myapp").
    WithConfigType("yaml").
    WithConfigPaths("./config").
    WithEnvPrefix("MYAPP").
    WithWatchConfig(true).
    WithDefault("port", 8080).
    Build()

if err != nil {
    log.Fatal(err)
}
defer manager.Close()

port := manager.GetInt("port")
fmt.Printf("Server will start on port: %d\n", port)
```

### å¿«é€Ÿå¯åŠ¨

```go
// æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼
manager, err := config.QuickStart(
    config.WithYAMLFile("./config.yaml"),
    config.WithDevelopment(),
)
if err != nil {
    log.Fatal(err)
}
defer manager.Close()
```

## ğŸ” åŠ å¯†é…ç½®ä½¿ç”¨

### åŸºæœ¬åŠ å¯†é…ç½®

```go
// æŒ‡å®šéœ€è¦åŠ å¯†çš„é…ç½®é”®
encryptedKeys := []string{"database.password", "api.secret_key"}

// åˆ›å»ºåŠ å¯†ç®¡ç†å™¨
manager, err := config.NewEncryptedViperManager(
    &config.Config{
        EncryptionKey: "your-encryption-key",
        ConfigName:    "app",
        ConfigType:    "yaml",
    },
    encryptedKeys,
)

if err != nil {
    log.Fatal(err)
}
defer manager.Close()

// è®¾ç½®æ•æ„Ÿä¿¡æ¯ï¼ˆè‡ªåŠ¨åŠ å¯†ï¼‰
manager.SetString("database.password", "super-secret-password")

// è¯»å–é…ç½®ï¼ˆè‡ªåŠ¨è§£å¯†ï¼‰
password := manager.GetString("database.password")
fmt.Println("Password:", password)
```

### æ”¯æŒçš„åŠ å¯†æ ‡è®°

åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨ç‰¹æ®Šæ ‡è®°ï¼š

```yaml
database:
  host: localhost
  port: 5432
  # è¿è¡Œæ—¶åŠ å¯†
  password: "${SECRET:actual_password}"
  
api:
  # å·²åŠ å¯†çš„å€¼
  secret: "${ENCRYPTED:base64_encrypted_value}"
```

## ğŸŒ å¤šç¯å¢ƒé…ç½®

### ç¯å¢ƒæ£€æµ‹å’Œç®¡ç†

```go
// è‡ªåŠ¨æ£€æµ‹å½“å‰ç¯å¢ƒ
detector := config.NewEnvironmentDetector()
currentEnv := detector.DetectEnvironment()

// åˆ›å»ºç¯å¢ƒç®¡ç†å™¨
envManager := config.NewEnvironmentManager(currentEnv)

// ä¸ºä¸åŒç¯å¢ƒè®¾ç½®é…ç½®è·¯å¾„
envManager.AddConfigPath(config.Development, "./config/dev")
envManager.AddConfigPath(config.Production, "./config/prod")
envManager.AddConfigPath(config.Testing, "./config/test")

// åŠ è½½ç¯å¢ƒç‰¹å®šé…ç½®
manager, err := envManager.LoadWithEnvironment(currentEnv, nil)
if err != nil {
    log.Fatal(err)
}
defer manager.Close()
```

### ç¯å¢ƒé…ç½®æ–‡ä»¶ç»“æ„

```
config/
â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ database.yaml
â”œâ”€â”€ prod/
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ database.yaml
â””â”€â”€ test/
    â”œâ”€â”€ config.yaml
    â””â”€â”€ database.yaml
```

## âœ… é…ç½®éªŒè¯

### åˆ›å»ºéªŒè¯è§„åˆ™

```go
validator := config.NewDefaultValidator()

// æ·»åŠ éªŒè¯è§„åˆ™
validator.AddRule(config.ValidationRule{
    Key:      "server.port",
    Required: true,
    Type:     "int",
    MinValue: 1024,
    MaxValue: 65535,
})

validator.AddRule(config.ValidationRule{
    Key:     "log.level",
    Type:    "string",
    Options: []interface{}{"debug", "info", "warn", "error"},
})

// è‡ªå®šä¹‰éªŒè¯å‡½æ•°
validator.AddRule(config.ValidationRule{
    Key:      "timeout",
    Type:     "duration",
    CustomFunc: func(value interface{}) error {
        if dur, ok := value.(time.Duration); ok {
            if dur < time.Second || dur > time.Hour {
                return fmt.Errorf("timeout must be between 1s and 1h")
            }
        }
        return nil
    },
})

// éªŒè¯é…ç½®
if err := manager.Validate(validator); err != nil {
    log.Printf("Config validation failed: %v", err)
}
```

## ğŸ”„ é…ç½®çƒ­é‡è½½

### ç›‘å¬é…ç½®å˜åŒ–

```go
// å¯ç”¨é…ç½®æ–‡ä»¶ç›‘å¬
config := config.DevelopmentConfig()
config.WatchConfig = true

manager := config.NewViperManager(config)
manager.Load()

// æ·»åŠ å˜åŒ–ç›‘å¬å™¨
manager.Watch(func(event config.Event) {
    fmt.Printf("Config changed: %s = %v (type: %s)\n", 
        event.Key, event.Value, event.Type)
        
    // æ ¹æ®é…ç½®å˜åŒ–æ‰§è¡Œç›¸åº”æ“ä½œ
    switch event.Key {
    case "log.level":
        // æ›´æ–°æ—¥å¿—çº§åˆ«
        updateLogLevel(event.Value.(string))
    case "database.pool_size":
        // è°ƒæ•´æ•°æ®åº“è¿æ¥æ± å¤§å°
        adjustDBPool(event.Value.(int))
    }
})
```

## ğŸ“Š ç»“æ„ä½“é…ç½®

### é…ç½®è§£æåˆ°ç»“æ„ä½“

```go
type DatabaseConfig struct {
    Host     string        `mapstructure:"host"`
    Port     int           `mapstructure:"port"`
    Username string        `mapstructure:"username"`
    Password string        `mapstructure:"password"`
    Timeout  time.Duration `mapstructure:"timeout"`
}

type AppConfig struct {
    Debug    bool           `mapstructure:"debug"`
    Port     int            `mapstructure:"port"`
    Database DatabaseConfig `mapstructure:"database"`
}

// è§£ææ•´ä¸ªé…ç½®
var appConfig AppConfig
if err := manager.Unmarshal(&appConfig); err != nil {
    log.Fatal(err)
}

// åªè§£æç‰¹å®šéƒ¨åˆ†
var dbConfig DatabaseConfig
if err := manager.UnmarshalKey("database", &dbConfig); err != nil {
    log.Fatal(err)
}
```

## ğŸ­ å·¥å‚æ¨¡å¼ä½¿ç”¨

### ç®¡ç†å™¨ç±»å‹

```go
// åŸºç¡€Viperç®¡ç†å™¨
basicManager, err := config.CreateManager(config.ViperManagerType, config.DefaultConfig())

// åŠ å¯†ç®¡ç†å™¨
encryptedManager, err := config.CreateManagerWithOptions(
    config.EncryptedManagerType, 
    encConfig, 
    []string{"secret.key"},
)

// ç¯å¢ƒç®¡ç†å™¨
envManager, err := config.CreateManagerWithOptions(
    config.EnvironmentManagerType, 
    nil, 
    config.Production,
)

// è‡ªåŠ¨æ£€æµ‹ç±»å‹
autoManager, err := config.CreateAuto(someConfig)
```

### ç®¡ç†å™¨æ³¨å†Œè¡¨

```go
registry := config.GetGlobalRegistry()

// æ³¨å†Œç®¡ç†å™¨
registry.Register("app", appManager)
registry.Register("cache", cacheManager)

// è·å–ç®¡ç†å™¨
if manager, exists := registry.Get("app"); exists {
    port := manager.GetInt("server.port")
}

// è·å–æˆ–åˆ›å»ºç®¡ç†å™¨
manager, err := registry.GetOrCreate(
    "database", 
    config.ViperManagerType, 
    dbConfig,
)
```

## ğŸ› ï¸ é«˜çº§ç‰¹æ€§

### é¢„è®¾å·¥å‚

```go
factory := config.GetPresetFactory()

// å¿«é€Ÿåˆ›å»ºä¸åŒç¯å¢ƒçš„ç®¡ç†å™¨
devManager, _ := factory.CreateDevelopment("./config/dev")
prodManager, _ := factory.CreateProduction("./config/prod")
testManager, _ := factory.CreateTesting("./config/test")

// åˆ›å»ºåŠ å¯†ç®¡ç†å™¨
encManager, _ := factory.CreateEncrypted(
    "encryption-key",
    []string{"db.password"},
    nil,
)
```

### é”™è¯¯å¤„ç†

```go
// è‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨
errorHandler := config.NewDefaultErrorHandler(func(format string, args ...interface{}) {
    log.Printf("[CONFIG] "+format, args...)
})

// å¤„ç†é…ç½®é”™è¯¯
err := manager.Load()
if err != nil {
    errorHandler.HandleError(err)
    
    // æ£€æŸ¥é”™è¯¯ç±»å‹
    if config.IsConfigError(err) {
        fmt.Println("This is a config error")
    }
    
    if config.IsConfigErrorWithCode(err, "CONFIG_NOT_FOUND") {
        fmt.Println("Config file not found")
    }
}
```

## ğŸ“ é…ç½®æ–‡ä»¶ç¤ºä¾‹

### åº”ç”¨é…ç½® (config.yaml)

```yaml
# åº”ç”¨åŸºæœ¬é…ç½®
app:
  name: "MyApp"
  version: "1.0.0"
  debug: true

# æœåŠ¡å™¨é…ç½®
server:
  host: "0.0.0.0"
  port: 8080
  read_timeout: "30s"
  write_timeout: "30s"

# æ•°æ®åº“é…ç½®
database:
  host: "localhost"
  port: 5432
  username: "app_user"
  password: "${SECRET:db_password_here}"
  ssl_mode: "require"
  max_connections: 20

# Redisé…ç½®
redis:
  host: "localhost"
  port: 6379
  db: 0
  password: "${SECRET:redis_password_here}"

# æ—¥å¿—é…ç½®
log:
  level: "info"
  format: "json"
  output: "stdout"

# APIé…ç½®
api:
  secret_key: "${SECRET:api_secret_key_here}"
  rate_limit: 1000
  timeout: "10s"
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# åº”ç”¨ç¯å¢ƒå˜é‡
export MYAPP_APP_NAME="MyApp Production"
export MYAPP_SERVER_PORT=80
export MYAPP_DATABASE_HOST="prod-db.example.com"
export MYAPP_LOG_LEVEL="warn"
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡Œç‰¹å®šæµ‹è¯•
go test -v -run TestConfig

# è¿è¡ŒåŸºå‡†æµ‹è¯•
go test -bench=.

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
go test -cover ./...
```

## ğŸ“š APIæ–‡æ¡£

### æ ¸å¿ƒæ¥å£

#### Manageræ¥å£
```go
type Manager interface {
    Load() error
    Reload() error
    Get(key string) interface{}
    GetString(key string) string
    GetInt(key string) int
    GetBool(key string) bool
    GetFloat64(key string) float64
    GetDuration(key string) time.Duration
    GetStringSlice(key string) []string
    Set(key string, value interface{})
    IsSet(key string) bool
    Unmarshal(rawVal interface{}) error
    UnmarshalKey(key string, rawVal interface{}) error
    Watch(callback func(event Event)) error
    StopWatch()
    Validate(validator Validator) error
    GetAllSettings() map[string]interface{}
    Close() error
}
```

#### å…¨å±€å‡½æ•°
```go
// åˆå§‹åŒ–
func Init(config *Config) error
func InitWithEncryption(config *Config, encryptedKeys []string) error
func InitWithEnvironment(env Environment, baseConfig *Config) error

// è¯»å–é…ç½®
func Get(key string) interface{}
func GetString(key string) string
func GetInt(key string) int
func GetBool(key string) bool
func GetFloat64(key string) float64
func GetDuration(key string) time.Duration
func GetStringSlice(key string) []string

// è®¾ç½®é…ç½®
func Set(key string, value interface{})
func IsSet(key string) bool

// ç»“æ„ä½“è§£æ
func Unmarshal(rawVal interface{}) error
func UnmarshalKey(key string, rawVal interface{}) error

// ç›‘å¬å’ŒéªŒè¯
func Watch(callback func(event Event)) error
func Validate(validator Validator) error

// ç”Ÿå‘½å‘¨æœŸ
func Reload() error
func Close() error
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# å…‹éš†ä»“åº“
git clone <repository-url>
cd basic/pkg/config

# å®‰è£…ä¾èµ–
go mod tidy

# è¿è¡Œæµ‹è¯•
go test ./...
```

### ä»£ç è§„èŒƒ

- éµå¾ª Go å®˜æ–¹ä»£ç è§„èŒƒ
- ä½¿ç”¨ `gofmt` æ ¼å¼åŒ–ä»£ç 
- é€šè¿‡ `go vet` é™æ€æ£€æŸ¥
- æ·»åŠ å¿…è¦çš„å•å…ƒæµ‹è¯•
- æ›´æ–°ç›¸å…³æ–‡æ¡£

### æäº¤è§„èŒƒ

```
<type>(<scope>): <subject>

<body>

<footer>
```

ç±»å‹è¯´æ˜ï¼š
- `feat`: æ–°åŠŸèƒ½
- `fix`: Bugä¿®å¤
- `docs`: æ–‡æ¡£æ›´æ–°
- `test`: æµ‹è¯•ç›¸å…³
- `refactor`: é‡æ„ä»£ç 

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ”— ç›¸å…³é“¾æ¥

- [Viper å®˜æ–¹æ–‡æ¡£](https://github.com/spf13/viper)
- [Go Modules æ–‡æ¡£](https://golang.org/ref/mod)
- [é¡¹ç›®ä¸»é¡µ](../../README.md)

## ğŸ“ æ”¯æŒä¸åé¦ˆ

- æäº¤ Issues
- å‚ä¸ Discussions
- è´¡çŒ®ä»£ç 

---

**ğŸš€ é«˜æ€§èƒ½ â€¢ ğŸ”’ å®‰å…¨å¯é  â€¢ ğŸŒ å¤šç¯å¢ƒ â€¢ âœ… ç±»å‹å®‰å…¨ â€¢ ğŸ”„ çƒ­é‡è½½**